---
import Heading from '../ui/Heading.astro';
import Image from '../ui/Image.astro';

export interface Props {
  heading?: string;
}

const { heading = 'Success Stories' } = Astro.props;

const modules = import.meta.glob('../../content/case-studies/*.mdx', { eager: true });
const caseStudies = Object.values(modules).map((mod: any) => mod.frontmatter);

const industries = Array.from(new Set(caseStudies.map((cs: any) => cs.industry)));
const services = Array.from(new Set(caseStudies.map((cs: any) => cs.service)));

const url = Astro.url;
const currentIndustry = url.searchParams.get('industry') || 'all';
const currentService = url.searchParams.get('service') || 'all';

function buildUrl(industry: string, service: string) {
  const params = new URLSearchParams();
  if (industry && industry !== 'all') params.set('industry', industry);
  if (service && service !== 'all') params.set('service', service);
  const query = params.toString();
  return `/success-stories${query ? `?${query}` : ''}`;
}

const filtered = caseStudies.filter((cs: any) =>
  (currentIndustry === 'all' || cs.industry === currentIndustry) &&
  (currentService === 'all' || cs.service === currentService)
);
---
<section class="section">
  <div class="container">
    <div class="text-center mb-12">
      <Heading level={2}>{heading}</Heading>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-6 justify-center mb-8">
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Industry</p>
        <div class="flex flex-wrap gap-2">
          <a href={buildUrl('all', currentService)} class={`px-3 py-1.5 rounded-full text-sm font-medium transition-all duration-200 ${currentIndustry === 'all' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>All</a>
          {industries.map(ind => (
            <a href={buildUrl(ind, currentService)} class={`px-3 py-1.5 rounded-full text-sm font-medium transition-all duration-200 capitalize ${currentIndustry === ind ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>{ind.replace('-', ' ')}</a>
          ))}
        </div>
      </div>
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Service</p>
        <div class="flex flex-wrap gap-2">
          <a href={buildUrl(currentIndustry, 'all')} class={`px-3 py-1.5 rounded-full text-sm font-medium transition-all duration-200 ${currentService === 'all' ? 'bg-green-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>All</a>
          {services.map(svc => (
            <a href={buildUrl(currentIndustry, svc)} class={`px-3 py-1.5 rounded-full text-sm font-medium transition-all duration-200 capitalize ${currentService === svc ? 'bg-green-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>{svc.replace('-', ' ')}</a>
          ))}
        </div>
      </div>
    </div>

    <!-- List -->
    <div class="grid md:grid-cols-2 lg:grid-cols-2 gap-6 mt-12">
      {filtered.map(cs => (
        <a href={`/success-stories/${cs.slug}`} class="block bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg hover:border-gray-300 transition-all duration-300 transform hover:-translate-y-1 overflow-hidden group">
          {cs.hero?.image && (
            <div class="relative overflow-hidden">
              <Image src={cs.hero.image} alt={cs.title} width={600} height={240} class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
            </div>
          )}
          <div class="p-5">
            <Heading level={3} class="text-lg font-bold text-gray-900 mb-3 leading-tight line-clamp-2">{cs.title}</Heading>
            <div class="flex gap-2 mb-3">
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 capitalize">
                {cs.industry.replace('-', ' ')}
              </span>
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 capitalize">
                {cs.service.replace('-', ' ')}
              </span>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed line-clamp-2">{cs.challenge}</p>
          </div>
        </a>
      ))}
    </div>
  </div>
</section>
