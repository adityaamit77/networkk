---
import Heading from '../ui/Heading.astro';
import Image from '../ui/Image.astro';

export interface Props {
  heading?: string;
}

const { heading } = Astro.props as Props;

const modules: Record<string, any> = import.meta.glob('../../content/insights/*.{json,mdx}', { eager: true });

const posts = Object.entries(modules).map(([path, mod]) => {
  const slug = path.replace('../../content/insights/', '').replace(/\.(json|mdx)$/,'');
  const data = path.endsWith('.mdx') ? mod.frontmatter : mod.default || mod;
  return { ...data, slug };
}).filter(Boolean);

let featuredPosts = posts.filter(p => p.featured);
if (!featuredPosts.length && posts.length) {
  featuredPosts = posts
    .sort(
      (a, b) =>
        new Date(b.publishedAt || 0).getTime() -
        new Date(a.publishedAt || 0).getTime()
    )
    .slice(0, 3);
}
---
{featuredPosts.length > 0 && (
  <section class="section bg-white">
    <div class="container">
      {heading && (
        <div class="text-center mb-8">
          <Heading level={2}>{heading}</Heading>
        </div>
      )}
      <div class="grid md:grid-cols-3 gap-8">
        {featuredPosts.map(post => (
          <article class="flex flex-col gap-4">
            {post.image && (
              <a href={`/insights/${post.slug}`} class="block">
                <Image
                  src={post.image}
                  alt={post.title}
                  class="w-full h-48 object-cover rounded-lg"
                  width={600}
                  height={400}
                />
              </a>
            )}
            <div>
              <Heading level={3} class="mb-2">
                {post.title}
              </Heading>
              {post.excerpt && (
                <p class="text-gray-600 mb-2">{post.excerpt}</p>
              )}
              <a
                href={`/insights/${post.slug}`}
                class="text-blue-600 font-medium"
                >Read more â†’</a
              >
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>
)}
