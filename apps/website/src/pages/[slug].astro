---
import PageLayout from '../layouts/PageLayout.astro';
import { loadPageBySlug } from '../lib/content/adapter';

// Generate static paths from content files
import path from 'path';
import fs from 'fs/promises';

export async function getStaticPaths() {
  // Use import.meta.glob as the primary method for more reliable file discovery
  const modules = import.meta.glob('../content/pages/*.json', { eager: true });
  
  const slugsFromGlob = Object.entries(modules).map(([filePath, module]) => {
    const fileName = filePath.replace('../content/pages/', '').replace('.json', '');
    return {
      slug: fileName,
      status: (module as any).status || 'published',
      source: 'import.meta.glob',
      filePath
    };
  });
  
  const validSlugs = slugsFromGlob.filter(item => {
    const isPublished = item.status === 'published';
    return isPublished;
  });
  
  const slugs = validSlugs.map(item => item.slug);
  
  return slugs.map(slug => ({
    params: { slug }
  }));
}

// Astro provides params as possibly undefined; cast to string for type safety
const slug = Astro.params.slug as string;
const page = await loadPageBySlug(slug);

if (!page) {
  return new Response(null, {
    status: 404,
    statusText: 'Page not found',
  });
}
---

<PageLayout page={page} theme="default" />

